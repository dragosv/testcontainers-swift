name: Test Bore Tunnel
on: [push, workflow_dispatch]
jobs:
  docker-host:
    runs-on: ubuntu-latest
    steps:
      - name: Expose Docker via bore
        run: |
          sudo systemctl start docker || true
          sudo chmod 666 /var/run/docker.sock
          curl -Ls https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-unknown-linux-musl.tar.gz | tar zx
          socat TCP-LISTEN:2375,fork,reuseaddr UNIX-CLIENT:/var/run/docker.sock &
          ./bore local 2375 --to bore.pub > bore.log 2>&1 &
          sleep 5
          PORT=$(grep -oP 'listening at bore.pub:\K\d+' bore.log | head -1)
          echo "$PORT" > docker-port.txt
      - uses: actions/upload-artifact@v4
        with:
          name: docker-port
          path: docker-port.txt
      - run: sleep 60

  macos-client:
    runs-on: macos-latest
    steps:
      - name: Wait for port
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in {1..20}; do
            gh run download ${{ github.run_id }} -n docker-port --dir . && break || sleep 5
          done
          PORT=$(cat docker-port.txt)
          curl -Ls https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-aarch64-apple-darwin.tar.gz | tar zx
          brew install socat docker
          sudo socat UNIX-LISTEN:/var/run/docker.sock,fork TCP:bore.pub:$PORT &
          export DOCKER_HOST="unix:///var/run/docker.sock"
          for i in {1..10}; do
            if docker --host unix:///var/run/docker.sock info > /dev/null 2>&1; then
              echo "Connected!"
              docker --host unix:///var/run/docker.sock info
              break
            fi
            sleep 3
          done
