name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  coverage:
    name: Swift Tests with Coverage
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'

    - name: Cache Swift dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-coverage-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-coverage-

    - name: Build for testing
      run: swift build --build-tests

    - name: Run tests with coverage
      run: swift test --enable-code-coverage --parallel

    - name: Find coverage profile data
      id: find-profdata
      run: |
        PROFDATA_PATH=$(find .build -name "default.profdata" -type f 2>/dev/null | head -1)
        echo "profdata_path=$PROFDATA_PATH" >> $GITHUB_OUTPUT
        echo "Found profdata at: $PROFDATA_PATH"

    - name: Find test binary
      id: find-binary
      run: |
        # Find the test binary - different locations on different platforms
        BINARY_PATH=$(find .build -name "*.xctest" -type d 2>/dev/null | head -1)
        if [ -n "$BINARY_PATH" ]; then
          # macOS .xctest bundle
          BINARY_PATH="$BINARY_PATH/Contents/MacOS/$(basename "$BINARY_PATH" .xctest)"
        else
          # Linux binary
          BINARY_PATH=$(find .build -name "*PackageTests" -type f -executable 2>/dev/null | head -1)
        fi
        echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT
        echo "Found binary at: $BINARY_PATH"

    - name: Generate LCOV coverage report
      run: |
        PROFDATA="${{ steps.find-profdata.outputs.profdata_path }}"
        BINARY="${{ steps.find-binary.outputs.binary_path }}"
        
        if [ -n "$PROFDATA" ] && [ -n "$BINARY" ] && [ -f "$PROFDATA" ] && [ -f "$BINARY" ]; then
          echo "Generating LCOV report..."
          xcrun llvm-cov export \
            -format="lcov" \
            -instr-profile="$PROFDATA" \
            "$BINARY" \
            > coverage.lcov
          
          echo "Coverage report generated successfully"
          echo "--- Coverage Summary ---"
          xcrun llvm-cov report \
            -instr-profile="$PROFDATA" \
            "$BINARY" \
            --ignore-filename-regex=".build|Tests" \
            2>/dev/null || true
        else
          echo "Warning: Could not find profdata or binary for coverage report"
          echo "PROFDATA: $PROFDATA"
          echo "BINARY: $BINARY"
          # Create empty coverage file to prevent upload failure
          touch coverage.lcov
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.lcov
        flags: swift,unittests
        name: testcontainers-swift-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.lcov
        retention-days: 30
        if-no-files-found: warn

  coverage-linux:
    name: Swift Tests with Coverage (Linux)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev llvm

    - name: Cache Swift dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          .swiftpm
        key: ${{ runner.os }}-swift-coverage-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-coverage-

    - name: Build for testing
      run: swift build --build-tests

    - name: Run tests with coverage
      run: swift test --enable-code-coverage --parallel

    - name: Find coverage profile data
      id: find-profdata
      run: |
        PROFDATA_PATH=$(find .build -name "default.profdata" -type f 2>/dev/null | head -1)
        echo "profdata_path=$PROFDATA_PATH" >> $GITHUB_OUTPUT
        echo "Found profdata at: $PROFDATA_PATH"

    - name: Find test binary
      id: find-binary
      run: |
        BINARY_PATH=$(find .build -name "*PackageTests.xctest" -type f -executable 2>/dev/null | head -1)
        echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT
        echo "Found binary at: $BINARY_PATH"

    - name: Generate LCOV coverage report
      run: |
        PROFDATA="${{ steps.find-profdata.outputs.profdata_path }}"
        BINARY="${{ steps.find-binary.outputs.binary_path }}"
        
        if [ -n "$PROFDATA" ] && [ -n "$BINARY" ] && [ -f "$PROFDATA" ] && [ -f "$BINARY" ]; then
          echo "Generating LCOV report..."
          llvm-cov export \
            -format="lcov" \
            -instr-profile="$PROFDATA" \
            "$BINARY" \
            > coverage.lcov
          
          echo "Coverage report generated successfully"
          echo "--- Coverage Summary ---"
          llvm-cov report \
            -instr-profile="$PROFDATA" \
            "$BINARY" \
            --ignore-filename-regex=".build|Tests" \
            2>/dev/null || true
        else
          echo "Warning: Could not find profdata or binary for coverage report"
          echo "PROFDATA: $PROFDATA"
          echo "BINARY: $BINARY"
          touch coverage.lcov
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.lcov
        flags: swift,unittests,linux
        name: testcontainers-swift-coverage-linux
        fail_ci_if_error: false
        verbose: true

    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-linux
        path: coverage.lcov
        retention-days: 30
        if-no-files-found: warn

