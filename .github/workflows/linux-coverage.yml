#name: Linux Tests with Coverage
#
#on:
#  push:
#    branches: [ main, develop ]
#  pull_request:
#    branches: [ main, develop ]
#  workflow_dispatch:
#
#jobs:
#  test-coverage-linux:
#    name: Swift Tests with Coverage (Linux)
#    runs-on: ubuntu-latest
#    container:
#      image: swift:6.2
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#      with:
#        fetch-depth: 0
#
#    - name: Install dependencies
#      run: |
#        apt-get update
#        apt-get install -y libsqlite3-dev llvm curl
#
#    - name: Cache Swift dependencies
#      uses: actions/cache@v4
#      with:
#        path: |
#          .build
#          .swiftpm
#        key: linux-swift-6.0-${{ hashFiles('Package.resolved') }}
#        restore-keys: |
#          linux-swift-6.0-
#
#    - name: Build
#      run: swift build --build-tests
#
#    - name: Run tests with coverage
#      run: swift test --enable-code-coverage --parallel
#
#    - name: Generate coverage report
#      run: |
#        # Find the profdata file
#        PROFDATA=$(find .build -name "default.profdata" -type f | head -1)
#        echo "Found profdata: $PROFDATA"
#
#        # Find the test binary
#        BINARY=$(find .build -name "*.xctest" -type f -executable | head -1)
#        if [ -z "$BINARY" ]; then
#          BINARY=$(find .build -type f -name "*PackageTests" -executable | head -1)
#        fi
#        echo "Found binary: $BINARY"
#
#        # Generate LCOV report
#        if [ -n "$PROFDATA" ] && [ -n "$BINARY" ] && [ -f "$PROFDATA" ]; then
#          llvm-cov export \
#            -format="lcov" \
#            -instr-profile="$PROFDATA" \
#            "$BINARY" \
#            -ignore-filename-regex=".build|Tests" \
#            > coverage.lcov
#
#          echo "✅ Coverage report generated"
#
#          # Print summary
#          echo "--- Coverage Summary ---"
#          llvm-cov report \
#            -instr-profile="$PROFDATA" \
#            "$BINARY" \
#            -ignore-filename-regex=".build|Tests" || true
#        else
#          echo "⚠️ Could not find coverage files"
#          echo "Available files:"
#          find .build -name "*.profdata" -o -name "*.xctest" 2>/dev/null | head -20
#          touch coverage.lcov
#        fi
#
#    - name: Upload coverage to Codecov
#      uses: codecov/codecov-action@v4
#      with:
#        token: ${{ secrets.CODECOV_TOKEN }}
#        files: ./coverage.lcov
#        flags: linux,unittests
#        name: testcontainers-swift-linux
#        fail_ci_if_error: false
#        verbose: true
#
#    - name: Upload coverage artifact
#      uses: actions/upload-artifact@v4
#      with:
#        name: coverage-report-linux
#        path: coverage.lcov
#        retention-days: 14
#        if-no-files-found: warn
#
